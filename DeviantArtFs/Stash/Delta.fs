namespace DeviantArtFs.Stash

open DeviantArtFs
open FSharp.Data

type DeltaResponse = JsonProvider<"""[{
    "cursor": "678ce5dfc5ebcd029db5b0f5720fb8fc",
    "has_more": true,
    "next_offset": 42,
    "reset": false,
    "entries": [
        {
            "stackid": 1519924909236375,
            "metadata": {
                "title": "Sta.sh Uploads 367",
                "path": "Saved Submissions/Sta.sh Uploads 367",
                "size": 1,
                "description": "",
                "parentid": 8092856735860464,
                "thumb": {
                    "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dcbtbto-f5b6fc2c-f18a-45ce-8cd9-d173f6d1e428.png",
                    "height": 128,
                    "width": 128,
                    "transparency": false
                },
                "stackid": 1519924909236375
            },
            "position": 40
        },
        {
            "itemid": 5041946760955267,
            "stackid": 82528086903970,
            "metadata": {
                "title": "Bsictiu",
                "description": null,
                "artist_comments": "A",
                "original_url": "O",
                "category": "C",
                "creation_time": 1539568626,
                "files": [
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dcpgrkn-be42e4a4-de0d-4980-bc0f-c8ab47fcfe82.png/v1/fit/w_150,h_150,q_70,strp/bsictiu_by_lizard_socks_dcpgrkn-150.jpg",
                        "height": 146,
                        "width": 150,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dcpgrkn-be42e4a4-de0d-4980-bc0f-c8ab47fcfe82.png/v1/fit/w_300,h_760,q_70,strp/bsictiu_by_lizard_socks_dcpgrkn-300w.jpg",
                        "height": 292,
                        "width": 300,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dcpgrkn-be42e4a4-de0d-4980-bc0f-c8ab47fcfe82.png/v1/fill/w_205,h_200,q_70,strp/bsictiu_by_lizard_socks_dcpgrkn-200h.jpg",
                        "height": 200,
                        "width": 205,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dcpgrkn-be42e4a4-de0d-4980-bc0f-c8ab47fcfe82.png",
                        "height": 760,
                        "width": 780,
                        "transparency": false
                    },
                    {
                        "src": "https://api-da.wixmp.com/_api/download/file?downloadToken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsImV4cCI6MTU0NTI3ODMxMiwiaWF0IjoxNTQ1Mjc3NzAyLCJqdGkiOiI1YzFiMTExMDBjOGFjIiwib2JqIjpudWxsLCJhdWQiOlsidXJuOnNlcnZpY2U6ZmlsZS5kb3dubG9hZCJdLCJwYXlsb2FkIjp7InBhdGgiOiJcL2ZcL2EyNjY3NmVkLTU3NTMtNGE4MS04OTA3LTE5OWJkOTA1Nzk2MFwvZGNwZ3Jrbi1iZTQyZTRhNC1kZTBkLTQ5ODAtYmMwZi1jOGFiNDdmY2ZlODIucG5nIn19.mCoY1NuNcU5GqXsqfbFdc768Ow1ji3Ewpo8wdM8P3bE",
                        "height": 760,
                        "width": 780,
                        "transparency": false
                    }
                ],
                "submission": {
                    "file_size": "67.9 KB",
                    "resolution": "780x760",
                    "submitted_with": {
                        "app": "DeviantArt",
                        "url": "https://www.deviantart.com"
                    }
                },
                "stats": {
                    "views": 0,
                    "views_today": 0,
                    "downloads": 0,
                    "downloads_today": 0
                },
                "stackid": 82528086903970,
                "itemid": 5041946760955267,
                "tags": ["t"]
            },
            "position": 0
        },
        {
            "itemid": 7793405659318437,
            "stackid": 3512995493952651,
            "metadata": {
                "title": "100 0500",
                "description": null,
                "artist_comments": "",
                "original_url": "",
                "category": "",
                "creation_time": 1532042965,
                "files": [
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dchppsq-a028929d-255a-4e2c-866c-fcd940fda423.jpg/v1/fit/w_150,h_150,q_70,strp/100_0500_by_lizard_socks_dchppsq-150.jpg",
                        "height": 100,
                        "width": 150,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dchppsq-a028929d-255a-4e2c-866c-fcd940fda423.jpg/v1/fit/w_300,h_900,q_70,strp/100_0500_by_lizard_socks_dchppsq-300w.jpg",
                        "height": 200,
                        "width": 300,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dchppsq-a028929d-255a-4e2c-866c-fcd940fda423.jpg/v1/fill/w_300,h_200,q_70,strp/100_0500_by_lizard_socks_dchppsq-200h.jpg",
                        "height": 200,
                        "width": 300,
                        "transparency": false
                    },
                    {
                        "src": "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/intermediary/f/a26676ed-5753-4a81-8907-199bd9057960/dchppsq-a028929d-255a-4e2c-866c-fcd940fda423.jpg/v1/fill/w_1024,h_683,q_70,strp/100_0500_by_lizard_socks_dchppsq-fullview.jpg",
                        "height": 683,
                        "width": 1024,
                        "transparency": false
                    },
                    {
                        "src": "https://api-da.wixmp.com/_api/download/file?downloadToken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsImV4cCI6MTU0NTI3ODQ3OCwiaWF0IjoxNTQ1Mjc3ODY4LCJqdGkiOiI1YzFiMTFiNmYzMjk3Iiwib2JqIjpudWxsLCJhdWQiOlsidXJuOnNlcnZpY2U6ZmlsZS5kb3dubG9hZCJdLCJwYXlsb2FkIjp7InBhdGgiOiJcL2ZcL2EyNjY3NmVkLTU3NTMtNGE4MS04OTA3LTE5OWJkOTA1Nzk2MFwvZGNocHBzcS1hMDI4OTI5ZC0yNTVhLTRlMmMtODY2Yy1mY2Q5NDBmZGE0MjMuanBnIn19.2b_WBBfn1MmCG9gz2Ht7R42DUqWSVVNKda3KWhmhWDI",
                        "height": 1440,
                        "width": 2160,
                        "transparency": false
                    }
                ],
                "submission": {
                    "file_size": "358 KB",
                    "resolution": "2160x1440",
                    "submitted_with": {
                        "app": "Sta.sh",
                        "url": "https://sta.sh"
                    }
                },
                "stats": {
                    "views": 0,
                    "views_today": 0,
                    "downloads": 0,
                    "downloads_today": 0
                },
                "camera": {
                    "make": "EASTMAN KODAK COMPANY",
                    "model": "KODAK DX4330 DIGITAL CAMERA",
                    "shutter_speed": "1/32 second",
                    "aperture": "F/2.8",
                    "focal_length": "8 mm",
                    "date_taken": "Jan 23, 2002, 5:23:24 AM",
                    "orientation": "1"
                },
                "stackid": 3512995493952651,
                "itemid": 7793405659318437,
                "tags": []
            },
            "position": 0
        }
    ]
}, {
    "cursor": "366d90716db162067d08775c20f72abe",
    "has_more": false,
    "next_offset": null,
    "reset": false,
    "entries": []
}]""", SampleIsList=true>

type DeltaRequest() = 
    member val Cursor = null with get, set
    member val Offset = 0 with get, set
    member val Limit = 120 with get, set
    member val ExtSubmission = false with get, set
    member val ExtCamera = false with get, set
    member val ExtStats = false with get, set

module Delta =
    let AsyncExecute token (req: DeltaRequest) = async {
        let query = seq {
            match Option.ofObj req.Cursor with
            | Some s -> yield sprintf "cursor=%s" (dafs.urlEncode s)
            | None -> ()
            yield sprintf "offset=%d" req.Offset
            yield sprintf "limit=%d" req.Limit
            yield sprintf "ext_submission=%b" req.ExtSubmission
            yield sprintf "ext_camera=%b" req.ExtCamera
            yield sprintf "ext_stats=%b" req.ExtStats
        }
        let req =
            query
            |> String.concat "&"
            |> sprintf "https://www.deviantart.com/api/v1/oauth2/stash/delta?%s"
            |> dafs.createRequest token
        let! json = dafs.asyncRead req
        return DeltaResponse.Parse json
    }